# path: backend/templates/note_soap_mdm.md.j2
{# Simple, fast template. Ensure non-subjective sentences carry at least one citation marker. #}
{% macro cite_any() -%}{% if citations and citations|length > 0 -%}[^{{ citations[0] }}]{%- endif %}{%- endmacro %}

# SOAP / MDM

**Chief Complaint:** {{ visit.chief_complaint }} {{ cite_any() }}

## HPI
{%- if visit.hpi.onset %}Onset: {{ visit.hpi.onset }} {{ cite_any() }}.
{%- endif %}
{%- if visit.hpi.quality %} Quality: {{ visit.hpi.quality }} {{ cite_any() }}.
{%- endif %}
{%- if visit.hpi.associated_symptoms and visit.hpi.associated_symptoms|length %} Associated symptoms: {{ visit.hpi.associated_symptoms|join(", ") }} {{ cite_any() }}.
{%- endif %}
{%- if visit.hpi.red_flags and visit.hpi.red_flags|length %} Red flags: {{ visit.hpi.red_flags|join(", ") }} {{ cite_any() }}.
{%- endif %}

## Exam
CV: {{ visit.exam_bits.cv or "n/a" }} {{ cite_any() }}.  
Lungs: {{ visit.exam_bits.lungs or "n/a" }} {{ cite_any() }}.

## Risks
{% if visit.risks and visit.risks|length -%}
- {{ visit.risks|join("\n- ") }} {{ cite_any() }}
{%- else -%}
None documented {{ cite_any() }}
{%- endif %}

## Plan / MDM
{%- if visit.plan_intents and visit.plan_intents|length %}
{% for p in visit.plan_intents -%}
- ({{ p.type }}) {{ p.name }}{% if p.dose %} — {{ p.dose }}{% endif %}{% if p.schedule and p.schedule|length %} — {{ p.schedule|join(", ") }}{% endif %} {{ cite_any() }}
{%- endfor %}
{%- else %}
- No active orders {{ cite_any() }}
{%- endif %}

---

### Citations
{%- if citations and citations|length %}
{%- for c in citations %}
[^{{ c }}]: {{ c }}
{%- endfor %}
{%- else %}
_No evidence chips available._
{%- endif %}
